name: Deploy dataflow job

steps:
  - name: google/cloud-sdk:alpine
    entrypoint: 'bash'
    args:
      - 'gsutil'
      - 'cp'
      - 'gs://dataflow-bucket-quickstart/gcs-etl-dataflow/pipeline-options/pipeline-options.json'
      - '/workspace/pipeline-options.json'

  - name: google/cloud-sdk:alpine
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apk add --no-cache jq
        jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|join(",")' /workspace/pipeline-options.json > /workspace/parameters.txt

  - name: 'gcr.io/cloud-builders/mvn'
    id: 'Get Project Version'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo $VERSION > /workspace/version.txt

  - name: google/cloud-sdk:alpine
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud dataflow flex-template run "gcs-etl-dataflow-$(date +%Y%m%d-%H%M%S)" \
          --template-file-gcs-location="gs://dataflow-bucket-quickstart/flex-template/gcs-etl-dataflow-flex-template.json" \
          --parameters="$(cat /workspace/parameters.txt)" \
          --temp-location="gs://dataflow-bucket-quickstart/gcs-etl-dataflow/temp" \
          --staging-location="gs://dataflow-bucket-quickstart/gcs-etl-dataflow/staging" \
          --num-workers=1 \
          --max-workers=1 \
          --region="us-central1" \
          --worker-machine-type="e2-standard-2"

options:
  logging: CLOUD_LOGGING_ONLY